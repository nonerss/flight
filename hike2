-- Fly GUI V4 (Cleaned)
local main = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local up = Instance.new("TextButton")
local down = Instance.new("TextButton")
local onof = Instance.new("TextButton")
local TextLabel = Instance.new("TextLabel")
local plus = Instance.new("TextButton")
local speedLabel = Instance.new("TextLabel")
local mine = Instance.new("TextButton")
local closebutton = Instance.new("TextButton")
local mini = Instance.new("TextButton")
local mini2 = Instance.new("TextButton")

-- Gui setup
main.Name = "FlyGUI"
main.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
main.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
main.ResetOnSpawn = false

Frame.Parent = main
Frame.BackgroundColor3 = Color3.fromRGB(163, 255, 137)
Frame.BorderColor3 = Color3.fromRGB(103, 221, 213)
Frame.Position = UDim2.new(0.1, 0, 0.38, 0)
Frame.Size = UDim2.new(0, 200, 0, 60)
Frame.Active = true
Frame.Draggable = true

-- Title
TextLabel.Parent = Frame
TextLabel.BackgroundColor3 = Color3.fromRGB(242, 60, 255)
TextLabel.Position = UDim2.new(0.25, 0, 0, 0)
TextLabel.Size = UDim2.new(0, 100, 0, 28)
TextLabel.Font = Enum.Font.SourceSans
TextLabel.Text = "Fly GUI V4"
TextLabel.TextColor3 = Color3.new(0, 0, 0)
TextLabel.TextScaled = true

-- Buttons
local function makeBtn(btn, parent, text, pos, size, color)
	btn.Parent = parent
	btn.Text = text
	btn.Position = pos
	btn.Size = size
	btn.BackgroundColor3 = color
	btn.TextColor3 = Color3.new(0, 0, 0)
	btn.Font = Enum.Font.SourceSans
	btn.TextScaled = true
end

makeBtn(up, Frame, "UP", UDim2.new(0, 0, 0, 0), UDim2.new(0, 45, 0, 28), Color3.fromRGB(79, 255, 152))
makeBtn(down, Frame, "DOWN", UDim2.new(0, 0, 0.5, 0), UDim2.new(0, 45, 0, 28), Color3.fromRGB(215, 255, 121))
makeBtn(onof, Frame, "Fly", UDim2.new(0.7, 0, 0.5, 0), UDim2.new(0, 56, 0, 28), Color3.fromRGB(255, 249, 74))
makeBtn(plus, Frame, "+", UDim2.new(0.25, 0, 0, 0), UDim2.new(0, 45, 0, 28), Color3.fromRGB(133, 145, 255))
makeBtn(mine, Frame, "-", UDim2.new(0.25, 0, 0.5, 0), UDim2.new(0, 45, 0, 28), Color3.fromRGB(123, 255, 247))

-- Speed label
speedLabel.Parent = Frame
speedLabel.Text = "1"
speedLabel.Position = UDim2.new(0.5, 0, 0.5, 0)
speedLabel.Size = UDim2.new(0, 45, 0, 28)
speedLabel.BackgroundColor3 = Color3.fromRGB(255, 85, 0)
speedLabel.TextScaled = true

-- Close/minimize
makeBtn(closebutton, Frame, "X", UDim2.new(0, 0, -1, 27), UDim2.new(0, 45, 0, 28), Color3.fromRGB(225, 25, 0))
makeBtn(mini, Frame, "-", UDim2.new(0, 44, -1, 27), UDim2.new(0, 45, 0, 28), Color3.fromRGB(192, 150, 230))
makeBtn(mini2, Frame, "+", UDim2.new(0, 44, -1, 57), UDim2.new(0, 45, 0, 28), Color3.fromRGB(192, 150, 230))
mini2.Visible = false

-- Fly logic
local flying = false
local speed = 1
local plr = game.Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local RS = game:GetService("RunService")

local ctrl = {f = 0, b = 0, l = 0, r = 0}
local bv, bg

local function startFly()
	local char = plr.Character or plr.CharacterAdded:Wait()
	local root = char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	bg = Instance.new("BodyGyro", root)
	bg.P = 9e4
	bg.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
	bg.CFrame = root.CFrame

	bv = Instance.new("BodyVelocity", root)
	bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
	bv.Velocity = Vector3.new(0, 0.1, 0)

	flying = true

	RS.RenderStepped:Connect(function()
		if not flying then return end
		local camCF = workspace.CurrentCamera.CFrame
		local move = Vector3.new(ctrl.l + ctrl.r, 0, ctrl.f + ctrl.b)
		if move.Magnitude > 0 then
			move = (camCF.RightVector * move.X + camCF.LookVector * move.Z).Unit * (speed * 5)
		end
		bv.Velocity = Vector3.new(move.X, move.Y, move.Z)
		bg.CFrame = camCF
	end)
end

local function stopFly()
	flying = false
	if bv then bv:Destroy() bv = nil end
	if bg then bg:Destroy() bg = nil end
end

-- Button actions
onof.MouseButton1Click:Connect(function()
	if flying then
		stopFly()
		onof.Text = "Fly"
	else
		startFly()
		onof.Text = "Stop"
	end
end)

plus.MouseButton1Click:Connect(function()
	speed = speed + 1
	speedLabel.Text = tostring(speed)
end)

mine.MouseButton1Click:Connect(function()
	if speed > 1 then
		speed = speed - 1
		speedLabel.Text = tostring(speed)
	end
end)

closebutton.MouseButton1Click:Connect(function() main:Destroy() end)

mini.MouseButton1Click:Connect(function()
	for _, v in pairs({up, down, onof, plus, mine, speedLabel}) do v.Visible = false end
	mini.Visible = false
	mini2.Visible = true
end)

mini2.MouseButton1Click:Connect(function()
	for _, v in pairs({up, down, onof, plus, mine, speedLabel}) do v.Visible = true end
	mini.Visible = true
	mini2.Visible = false
end)

-- Up/Down buttons
up.MouseButton1Click:Connect(function()
	if plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
		plr.Character.HumanoidRootPart.CFrame *= CFrame.new(0, 5, 0)
	end
end)

down.MouseButton1Click:Connect(function()
	if plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
		plr.Character.HumanoidRootPart.CFrame *= CFrame.new(0, -5, 0)
	end
end)

-- Keybinds for WASD
UIS.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == Enum.KeyCode.W then ctrl.f = 1 end
	if input.KeyCode == Enum.KeyCode.S then ctrl.b = -1 end
	if input.KeyCode == Enum.KeyCode.A then ctrl.l = -1 end
	if input.KeyCode == Enum.KeyCode.D then ctrl.r = 1 end
end)

UIS.InputEnded:Connect(function(input)
	if input.KeyCode == Enum.KeyCode.W then ctrl.f = 0 end
	if input.KeyCode == Enum.KeyCode.S then ctrl.b = 0 end
	if input.KeyCode == Enum.KeyCode.A then ctrl.l = 0 end
	if input.KeyCode == Enum.KeyCode.D then ctrl.r = 0 end
end)
